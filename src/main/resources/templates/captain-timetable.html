<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìº¡í‹´ - íšŒì˜ ì¼ì • ì„¤ì •</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
</head>
<body>
<h2>ğŸ“… íšŒì˜ ì¼ì • ì„¤ì •</h2>

<label>íšŒì˜ ì´ë¦„:</label>
<input type="text" id="meetingName" placeholder="íšŒì˜ ì´ë¦„ ì…ë ¥">

<label>ë§ˆê° ê¸°í•œ:</label>
<input type="datetime-local" id="deadline">

<label>ì‹œì‘ ë‚ ì§œ:</label>
<input type="date" id="startDate">

<label>ì¢…ë£Œ ë‚ ì§œ:</label>
<input type="date" id="endDate">

<label>ì‹œì‘ ì‹œê°„:</label>
<input type="time" id="startTime">

<label>ì¢…ë£Œ ì‹œê°„:</label>
<input type="time" id="endTime">

<button onclick="setMeeting()">ì €ì¥</button>

<h3>âœ… í˜„ì¬ í”„ë¡œì íŠ¸ ì¼ì •</h3>
<ul id="timetableList"></ul>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    let projectId = urlParams.get('projectId');

    function setMeeting() {
        console.log("ğŸ“Œ 'ì €ì¥' ë²„íŠ¼ í´ë¦­ë¨!");

        let meetingName = document.getElementById('meetingName').value;
        let startDate = document.getElementById('startDate').value;
        let endDate = document.getElementById('endDate').value;
        let startTime = document.getElementById('startTime').value;
        let endTime = document.getElementById('endTime').value;

        // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë˜ëŠ” API ìš”ì²­)
        fetch('/api/users/me')
            .then(response => response.json())
            .then(user => {
                let userId = user.userId; // âœ… userId ê°’ ê°€ì ¸ì˜¤ê¸°

                // âœ… í˜„ì¬ ì‹œê°„ ê¸°ì¤€ 7ì¼ ë’¤ì˜ ë‚ ì§œ ê³„ì‚° (ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
                let deadline = new Date();
                deadline.setDate(deadline.getDate() + 7);  // í˜„ì¬ ë‚ ì§œ + 7ì¼
                let deadlineISO = deadline.toISOString();  // MySQL TIMESTAMP í˜•ì‹ìœ¼ë¡œ ë³€í™˜

                if (!projectId || !meetingName || !startDate || !endDate || !startTime || !endTime || !userId) {
                    alert("âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                let requestData = {
                    meetingName: meetingName,
                    startDate: startDate,
                    endDate: endDate,
                    startTime: startTime,
                    endTime: endTime,
                    userId: userId,  // âœ… ì¶”ê°€ë¨
                    projectId: projectId,  // âœ… ì¶”ê°€ë¨
                    deadline: deadlineISO  // âœ… ì¶”ê°€ë¨
                };

                console.log("ğŸ“¤ ì €ì¥ ìš”ì²­ ë°ì´í„°:", requestData);

                fetch(`/api/timetables/${projectId}/create`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestData)
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("âœ… ì €ì¥ ì„±ê³µ:", data);
                        alert("âœ… ì•½ì† ì‹œê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    })
                    .catch(error => {
                        console.error("âŒ ì €ì¥ ì‹¤íŒ¨:", error);
                        alert("âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                    });
            })
            .catch(error => {
                console.error("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
                alert("âš ï¸ ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            });

        function loadTimetable() {
            fetch(`/api/timetables/${projectId}`)
                .then(response => response.json())
                .then(timetables => {
                    let timetableList = $("#timetableList");
                    timetableList.empty();
                    timetables.forEach(t => {
                        timetableList.append(`<li>${t.meetingName} - ${t.startDate} ${t.startTime} ~ ${t.endDate} ${t.endTime}</li>`);
                    });
                })
                .catch(error => console.error("âŒ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
        }
    }

    $(document).ready(loadTimetable);
</script>
</body>
</html>
